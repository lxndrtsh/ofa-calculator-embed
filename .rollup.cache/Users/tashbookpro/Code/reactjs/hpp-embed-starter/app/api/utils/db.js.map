{"version":3,"file":"db.js","sourceRoot":"","sources":["db.ts"],"names":[],"mappings":"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","sourcesContent":["import mysql from 'mysql2/promise';\n\n// Get database connection from environment variables\nfunction getDbConfig() {\n  return {\n    host: process.env.DB_HOST,\n    user: process.env.DB_USER,\n    password: process.env.DB_PASSWORD,\n    database: process.env.DB_NAME,\n    port: process.env.DB_PORT ? parseInt(process.env.DB_PORT) : 3306,\n  };\n}\n\n// Create a connection pool (reusable connections)\nlet pool: mysql.Pool | null = null;\n\nfunction getPool(): mysql.Pool {\n  if (!pool) {\n    const config = getDbConfig();\n    if (!config.host || !config.user || !config.password || !config.database) {\n      throw new Error('Database configuration is missing. Please set DB_HOST, DB_USER, DB_PASSWORD, and DB_NAME environment variables.');\n    }\n    pool = mysql.createPool({\n      ...config,\n      waitForConnections: true,\n      connectionLimit: 10,\n      queueLimit: 0,\n    });\n  }\n  return pool;\n}\n\n// Save impact submission to database\nexport async function saveImpactSubmission(\n  websiteUrl: string | null,\n  formData: any,\n  responseData: any\n): Promise<void> {\n  try {\n    const connection = await getPool().getConnection();\n    try {\n      await connection.query(\n        `INSERT INTO ofa_impact_submissions (date_submitted, website_url, form_data, response_data) \n         VALUES (NOW(), ?, ?, ?)`,\n        [\n          websiteUrl || null,\n          JSON.stringify(formData),\n          JSON.stringify(responseData),\n        ]\n      );\n    } finally {\n      connection.release();\n    }\n  } catch (error) {\n    // Log error but don't throw - we don't want DB failures to break submissions\n    console.error('Failed to save impact submission to database:', error);\n  }\n}\n\n// Save community submission to database\nexport async function saveCommunitySubmission(\n  websiteUrl: string | null,\n  formData: any,\n  responseData: any\n): Promise<void> {\n  try {\n    const connection = await getPool().getConnection();\n    try {\n      await connection.query(\n        `INSERT INTO ofa_community_submissions (date_submitted, website_url, form_data, response_data) \n         VALUES (NOW(), ?, ?, ?)`,\n        [\n          websiteUrl || null,\n          JSON.stringify(formData),\n          JSON.stringify(responseData),\n        ]\n      );\n    } finally {\n      connection.release();\n    }\n  } catch (error) {\n    // Log error but don't throw - we don't want DB failures to break submissions\n    console.error('Failed to save community submission to database:', error);\n  }\n}\n\n// Helper to get website URL from request\nexport function getWebsiteUrl(req: Request): string | null {\n  // Try origin first (most reliable)\n  const origin = req.headers.get('origin');\n  if (origin) return origin;\n\n  // Fall back to referer\n  const referer = req.headers.get('referer');\n  if (referer) {\n    try {\n      const url = new URL(referer);\n      return url.origin;\n    } catch {\n      return referer;\n    }\n  }\n\n  return null;\n}\n\n"]}